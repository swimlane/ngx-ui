<div [hidden]="!expanded">
  @for (prop of propertyIndex | objectValues; track trackBy($index, prop)) {
    <div>
      <div class="property-def" [class.invalid]="duplicatedFields.has($any(prop).id)">
        <ngx-dropdown>
          <ngx-dropdown-toggle>
            <div class="type-icon">
              <ngx-icon [fontIcon]="$any(prop).$meta.icon"></ngx-icon>
            </div>
          </ngx-dropdown-toggle>
          <ngx-dropdown-menu class="ngx-dropdown-menu">
            <ul class="vertical-list">
              <li>
                <button
                  type="button"
                  (click)="deleteProperty($any(prop).propertyName)"
                  [disabled]="requiredCache[$any(prop).propertyName]"
                  >
                  Delete
                </button>
              </li>
              @if ($any(prop)?.$meta?.type) {
                @for (type of $any(prop)?.$meta?.type; track type) {
                  <li>
                    <button
                      type="button"
                      (click)="changePropertyType(prop, type)"
                      [disabled]="$any(prop).$meta.currentType === type"
                      >
                      Change type to {{ dataTypeMap[type].name }}
                    </button>
                  </li>
                }
              }
            </ul>
          </ngx-dropdown-menu>
        </ngx-dropdown>
        <div class="property-name">
          @if ($any(prop).nameEditable) {
            <input
              type="text"
              [ngModel]="$any(prop).propertyName"
              (ngModelChange)="updatePropertyName($any(prop).id, $event)"
              />
          }
          @if (!$any(prop)?.nameEditable) {
            <div class="title" ngx-tooltip [tooltipTitle]="$any(prop)?.description ? $any(prop)?.description : $any(prop)?.propertyName">
              {{ $any(prop)?.title ? $any(prop)?.title : $any(prop)?.propertyName }}
              @if (requiredCache[$any(prop).propertyName]) {
                <span>*</span>
              }
            </div>
          }
        </div>
      </div>
      <ngx-json-editor-node
        [model]="model[$any(prop).propertyName]"
        (modelChange)="updateProp($any(prop).id, $event)"
        [schema]="prop"
        [required]="!!requiredCache[$any(prop).propertyName]"
        [inline]="$any(prop).type !== 'array' && $any(prop).type !== 'object'"
        [path]="path + getPath($any(prop).propertyName)"
        [isDuplicated]="duplicatedFields.has($any(prop).id)"
        [errors]="errors"
        [typeCheckOverrides]="typeCheckOverrides"
        [showKnownProperties]="showKnownProperties"
        [passwordToggleEnabled]="passwordToggleEnabled"
        >
      </ngx-json-editor-node>
    </div>
  }

  <ngx-dropdown>
    <ngx-dropdown-toggle [disabled]="isDuplicated">
      <div class="add-button">
        <ngx-icon fontIcon="plus-bold"></ngx-icon>
      </div>
    </ngx-dropdown-toggle>
    <ngx-dropdown-menu class="ngx-dropdown-menu">
      @if (schema.properties) {
        <ul class="vertical-list dropdown-column">
          @for (prop of schema.properties | keyvalue; track prop) {
            <li (click)="addSchemaProperty(prop.key)">
              <button [disabled]="model[prop.key] !== undefined" type="button">
                {{ prop.value.title ? prop.value.title : prop.key }}
              </button>
            </li>
          }
        </ul>
      }
      @if (!schema || schema.patternProperties || schema.additionalProperties !== false) {
        <ul
          class="vertical-list dropdown-column"
          >
          @for (prop of schema.patternProperties | keyvalue; track prop) {
            <li (click)="addSchemaPatternProperty(prop.key)">
              <button type="button">{{ prop.value.title ? prop.value.title : prop.key }}</button>
            </li>
          }
          @if (!schema || schema.additionalProperties !== false) {
            @for (dataType of dataTypes; track dataType) {
              <li (click)="addProperty(dataType)">
                <button type="button">{{ dataType.name }}</button>
              </li>
            }
          }
        </ul>
      }
    </ngx-dropdown-menu>
  </ngx-dropdown>
</div>
